<!DOCTYPE html>
<!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if IE 7]> <html class="no-js lt-ie9 lt-ie8" lang="en"> <![endif]-->
<!--[if IE 8]> <html class="no-js lt-ie9" lang="en"> <![endif]-->
<!--[if gt IE 8] -->
<html lang="en">
  <!-- <![endif] -->
  <head>
  <meta charset="utf-8" />
  <!-- %meta{:content => "IE=edge,chrome=1", "http-equiv" => "X-UA-Compatible"} -->
  <title>10.000 indultos</title>
  <meta content="El indultometro" name="description" />
  <meta content="width=device-width, initial-scale=1.0" name="viewport" />
  <!--[if lt IE 9]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
  <link href="/favicon.ico" rel="shortcut icon" />
  <link href="/images/apple-touch-icon-114x114-precomposed.png" rel="apple-touch-icon-precomposed" sizes="114x114" />
  <link href="/images/apple-touch-icon-72x72-precomposed.png" rel="apple-touch-icon-precomposed" sizes="72x72" />
  <link href="/images/apple-touch-icon-57x57-precomposed.png" rel="apple-touch-icon-precomposed" />
  <link href="/stylesheets/bootstrap.css" media="screen" rel="stylesheet" type="text/css" />
  <link href="/stylesheets/responsive.css" media="screen" rel="stylesheet" type="text/css" />
  <link href="/stylesheets/font-awesome.css" media="screen" rel="stylesheet" type="text/css" />
  <link href="/stylesheets/theme.css" media="screen" rel="stylesheet" type="text/css" />
  <link href="/stylesheets/fonts.css" media="screen" rel="stylesheet" type="text/css" />
  <link href="/stylesheets/custom.css" media="screen" rel="stylesheet" type="text/css" />
  <link href="/stylesheets/footable-0.1.css" media="screen" rel="stylesheet" type="text/css" />
  <link href="/stylesheets/footable.sortable.css" media="screen" rel="stylesheet" type="text/css" />
</head>
<body class="theme-pattern-concrete-wall" >
  <!-- Page Header -->
  <header id="masthead">
    <nav class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <a class="btn btn-navbar" data-target=".nav-collapse" data-toggle="collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
          <h1 class="brand">
            <a href="/index.html">
              El indultómetro
              <i class="icon-legal"></i>
            </a>
          </h1>
          <div class="nav-collapse collapse">
            <ul class="nav pull-right">
              <li class=" active "><a href="/indultos.html">10.000 indultos</a></li>
              <li class=""><a href="/famosos.html">Destacados</a></li>
              <li class=""><a href="/noticias.html">En los medios</a></li>
              <li class=""><a href="/ayuda.html">¿Qué es esto?</a></li>
            </ul>
          </div>
        </div>
      </div>
    </nav>
  </header>

<!-- Main Content -->
<div id="content" role="main">
<section class="section alt" id="promo">
  <div class="container">
    <div class="hero-unit">
      <h1>10.000 indultos</h1>
    </div>
  </div>
</section>
<section class="section">
  <div class="container">
    <div class="row-fluid">
      <div class="span12">
        <article class="blog-post">
          <header class="blog-header">
            <h2>
              This is the lead
            </h2>
          </header>
          <p>
            Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod
            tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam,
            quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo
            consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse
            cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non
            proident, sunt in culpa qui officia deserunt mollit anim id est laborum.
          </p>
          <div class="row-fluid">
            <div class="span10 offset1">
              <form id="search-form">
                <input type="text" class="span6" id="search-form-query">
                <button type="submit" class="btn">Buscar delito</button>
              </form>
            </div>
            <div id="pop-up">
              <div id="pop-up-title"></div>
              <div id="pop-up-content">Haga click para verlos en detalle</div>
            </div>
            <div class="span10 offset1" id="summary-viz">
            </div>
            <div class="span10 offset1">
              <small>
                <table class="table table-bordered table-striped footable" id="indultos">
                  <thead>
                    <tr>
                      <th data-class="expand">Id</th>
                      <th data-sort-initial="true">Fecha</th>
                      <th data-hide="phone">Rol</th>
                      <th data-hide="phone">Delito</th>
                      <th data-sort-ignore="true"></th>
                      <!-- FIXME: Cambiar los campos: quitar rol... -->
                    </tr>
                  </thead>
                  <tbody>

                  </tbody>
                </table>
              </small>
            </div>
          </div>
        </article>
      </div>
    </div>
  </div>
</section>
</div>

<script type='text/javascript'>
  // http://samsaffron.com/archive/2012/02/17/stop-paying-your-jquery-tax
  window.q=[];window.$=function(f){q.push(f)}
</script>


<!-- // FIXME: Move this to separate file -->
<style>
.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

.bar {
  fill: #41B7D8;
}

rect.hovered {
  fill: #666666;
}

rect.selected {
  fill: #000000;
}

.bar:hover {
  cursor: pointer;
  cursor: hand;
}

.x.axis path {
  display: none;
}

.x.axis text {
  font-size: 12px;
}

.y.axis text {
  font-size: 12px;
}

div#pop-up {
  display: none;
  position:absolute;
  color: white;
  background: rgba(0,0,0,0.5);
  padding: 5px 10px 5px 10px;
  -moz-border-radius: 8px 8px;
  border-radius: 8px 8px;
  pointer-events: none;
}
div#pop-up-title {
  font-size: 14px;
  margin-bottom: 4px;
  font-weight: bolder;
}
div#pop-up-content {
  font-size: 12px;
}
</style>
<script> 
  $(function() {
    // FIXME: Move this to separate file

    function renderSearchResults(data) {
      renderResults(data)
      updateData = summarizeData(data)
      redraw(updateData)

    }
    
    function renderResults(data) {
      $('#indultos tbody').empty();
      var fragments = [];
      $.each(data, function(key, pardon) {
        fragments.push('<tr>');
        fragments.push('<td><a href="http://www.boe.es/diario_boe/txt.php?id='+pardon['id']+'">'+pardon['id']+'</td>')
        fragments.push('<td>'+pardon['pardon_date']+'</td>')
        fragments.push('<td>'+pardon['role']+'</td>')
        fragments.push('<td>'+pardon['crime']+'</td>')
        fragments.push('<td><a href="/indulto.html?id='+pardon['id']+'">&rarr;</td>')
        fragments.push('</tr>');
      });
      $(fragments.join('')).appendTo('#indultos tbody');
      $('.footable').footable();
    }

    function displayYear(year) {
      $.ajax({
        url: '/api/pardons?callback=?',
        data: {year: year},
        dataType: "jsonp",
        jsonpCallback: "onLoad",
        cache: false  // FIXME: development
      }).success(renderResults);      
    }

    function doSearch(query) {
      $.ajax({
        url: '/api/search',
        data: {q: query},
      }).success(renderSearchResults);      
    }
    
    function summarizeData(data) {
      auxData = d3.nest()
        .key(function(d) {return d.pardon_year;})
        .sortKeys(d3.ascending)
        .rollup(function (a) {return a.length})
        .map(data);
      newData = [];
      years = d3.range(1996,2014,1);
      years.forEach(function(el) {
        o = {}
        o.year = el
        o.count = auxData[el] ? auxData[el] : 0
        newData.push(o)
      });
      return newData;
    }
    
    function redraw(data) {
      // Update…
      y.domain([0, d3.max(data, function(d) { return d.count; })]);       
      svg.select("g.y")
          .call(yAxis);
      
      svg.selectAll("rect")
           .data(data)
           .transition()
           .duration(1000)
           .attr("y", function(d) { return y(d.count); })
           .attr("height", function(d) { return height - y(d.count); })

    }

    function onMouseOver(d) {
      if (!d3.select(this).classed("selected"))
        d3.select(this).classed("hovered",true);
      $("#pop-up-title").html(d.year + ": " + d.count + " Indultos")
      var popLeft = d3.event.pageX - $("div#pop-up").width() / 2;
      var popTop = d3.event.pageY - $("div#pop-up").height() -350;
      $("div#pop-up").css({"left":popLeft,"top":popTop}).show();

    }
    
    function onMouseOut(d) {
      d3.select(this).classed("hovered",false);
      $("div#pop-up").hide();  
    }

    function onMouseClick(d) {
      if (d3.select(this).classed("selected")) {
        d3.select(this).classed("selected",false)
      }
      else {
        d3.selectAll("rect").classed("selected",false)
        d3.select(this).classed("selected",true)
      }
      $("#search-form-query").val()
      displayYear(d.year);
    }

    var margin = {top: 20, right: 20, bottom: 30, left: 60},
        width = 800 - margin.left - margin.right,
        height = 300 - margin.top - margin.bottom;

    var x = d3.scale.ordinal()
        .rangeRoundBands([0, width], .1);

    var y = d3.scale.linear()
        .range([height, 0]);

    var xAxis = d3.svg.axis()
        .scale(x)
        .orient("bottom");

    var yAxis = d3.svg.axis()
        .scale(y)
        .orient("left");

    var svg = d3.select("#summary-viz").append("svg")
        .attr("width", '100%')
        .attr("height", height + margin.top + margin.bottom)
      .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    d3.json("/api/summary", function(error, data) {
      if (error) return console.warn(error);

      x.domain(data.map(function(d) { return d.year; }));
      y.domain([0, d3.max(data, function(d) { return d.count; })]);

      svg.append("g")
          .attr("class", "x axis")
          .attr("transform", "translate(0," + height + ")")
          .call(xAxis);

      svg.append("g")
          .attr("class", "y axis")
          .attr("transform", "translate(-10," + 0 + ")")
          .call(yAxis)
        .append("text")
          .attr("transform", "rotate(-90)")
          .attr("y", 6)
          .attr("dy", ".71em")
          .style("text-anchor", "end")
          .text("Indultos");

      svg.selectAll(".bar")
          .data(data)
        .enter().append("rect")
          .attr("class", "bar")
          .attr("id", function(d) { return "a_"+d.year; })
          .attr("x", function(d) { return x(d.year); })
          .attr("width", x.rangeBand())
          .attr("y", function(d) { return y(d.count); })
          .attr("height", function(d) { return height - y(d.count); })
          .on("mouseover", onMouseOver)
          .on("mouseout", onMouseOut)
          .on("click", onMouseClick);
    });

    displayYear('2013');
    //FIXME: Not working needs probably a delay
    prueba = d3.select("rect#a_2013").classed("selected",true);

    $("#search-form").submit(function() {
      doSearch($("#search-form-query").val());
      // FIXME: Update viz with results summary
      return false;
    });
  });
</script>

<!-- Page Footer -->
<footer class="section" id="footer" role="contentinfo">
  <div class="container">
    <div class="row-fluid">
      <div class="span4">
        <h3>Contacta con nosotros</h3>
        <p>
          La Fundación Ciudadana Civio es una organización sin ánimo de lucro...
        </p>
        <ul class="icons">
          <li>
            <i class="icon-envelope"></i>
            <a href="mailto:contacto@civio.es">contacto@civio.es</a>
          </li>
          <li>
            <i class="icon-twitter"></i>
            <a href="http://twitter.com/civio/" target="_blank">@civio</a>
          </li>
          <li>
            <i class="icon-facebook"></i>
            <a href="http://facebook.com/fundacioncivio" target="_blank">Civio</a>
          </li>
        </ul>
      </div>
      <div class="span4">
        <h3>El indultómetro</h3>
        <p>
          Un proyecto de Juan Elosua (@jjelosua) y David Cabo (@dcabo) para Civio... Con la ayuda de... Pilla el código aquí... 
        </p>
        </ul>
      </div>
      <div class="span4">
        <h3>Noticias</h3>
        <ul class="unstyled">
          
          <li>
            <h4>
              <a href="/2013/01/29/ley-provisiona-cumple-siglo-y-medio.html" title="Una ley provisional que cumple siglo y medio">Una ley provisional que cumple siglo y medio</a>
            </h4>
            <p>
              <small>Eva Belmonte. 29 de enero de 2013</small>
            </p>
          </li>
          
          <li>
            <h4>
              <a href="/2013/01/29/coto-libre-del-gobierno.html" title="Los indultos, coto libre del gobierno">Los indultos, coto libre del gobierno</a>
            </h4>
            <p>
              <small>Eva Belmonte. 29 de enero de 2013</small>
            </p>
          </li>
          
          <li>
            <h4>
              <a href="/2012/12/03/indulta-que-nada-queda.html" title="Indulta, que nada queda (TeG)">Indulta, que nada queda (TeG)</a>
            </h4>
            <p>
              <small>Rodrigo Tena Arregui. 03 de diciembre de 2012</small>
            </p>
          </li>
          
        </ul>
      </div>
    </div>
  </div>
</footer>
<script src="/javascripts/jquery.min.js" type="text/javascript"></script>
<script src="/javascripts/bootstrap.js" type="text/javascript"></script>
<script src="/javascripts/script.js" type="text/javascript"></script>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="/javascripts/URI.min.js" type="text/javascript"></script>
<script src="/javascripts/footable-0.1.js" type="text/javascript"></script>
<script src="/javascripts/footable.sortable.js" type="text/javascript"></script>
<script type="text/javascript">$.each(q,function(i,f){$(f)})</script>
<script type="text/javascript">
if (typeof gaJsHost == 'undefined') {
  var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
  document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
}
</script>
<script type="text/javascript">
try {
var pageTracker = _gat._getTracker("#########");
pageTracker._trackPageview();
} catch(err) {}</script>
</body>
</html>
